<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 17. JavaScript Tools and Extensions | 《JavaScript 权威指南第七版》中文翻译</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="./assets/css/0.styles.3e8a7b6b.css" as="style"><link rel="preload" href="./assets/js/app.806b1433.js" as="script"><link rel="preload" href="./assets/js/2.d222cfdb.js" as="script"><link rel="preload" href="./assets/js/1.7462a745.js" as="script"><link rel="preload" href="./assets/js/32.239f4c63.js" as="script"><link rel="prefetch" href="./assets/js/10.93b4f749.js"><link rel="prefetch" href="./assets/js/11.5e44f9f1.js"><link rel="prefetch" href="./assets/js/12.65d08f50.js"><link rel="prefetch" href="./assets/js/13.6bcb3793.js"><link rel="prefetch" href="./assets/js/14.1f3b8559.js"><link rel="prefetch" href="./assets/js/15.de05e356.js"><link rel="prefetch" href="./assets/js/16.4a1dc3df.js"><link rel="prefetch" href="./assets/js/17.0a3a3e12.js"><link rel="prefetch" href="./assets/js/18.81a56757.js"><link rel="prefetch" href="./assets/js/19.ca0120fa.js"><link rel="prefetch" href="./assets/js/20.03b27e97.js"><link rel="prefetch" href="./assets/js/21.e943f9a6.js"><link rel="prefetch" href="./assets/js/22.1395e8d5.js"><link rel="prefetch" href="./assets/js/23.58e9e744.js"><link rel="prefetch" href="./assets/js/24.372b35e4.js"><link rel="prefetch" href="./assets/js/25.5ca92353.js"><link rel="prefetch" href="./assets/js/26.04ebee94.js"><link rel="prefetch" href="./assets/js/27.290f5e45.js"><link rel="prefetch" href="./assets/js/28.9cb6e60c.js"><link rel="prefetch" href="./assets/js/29.1b3d7c53.js"><link rel="prefetch" href="./assets/js/3.a04e1a1f.js"><link rel="prefetch" href="./assets/js/30.2e0de29b.js"><link rel="prefetch" href="./assets/js/31.f16cce01.js"><link rel="prefetch" href="./assets/js/33.2b24baff.js"><link rel="prefetch" href="./assets/js/34.2116d916.js"><link rel="prefetch" href="./assets/js/35.5c7536ba.js"><link rel="prefetch" href="./assets/js/36.168ba09f.js"><link rel="prefetch" href="./assets/js/37.8ddd8669.js"><link rel="prefetch" href="./assets/js/38.76b6b5a9.js"><link rel="prefetch" href="./assets/js/39.9dc1c832.js"><link rel="prefetch" href="./assets/js/4.e26ea152.js"><link rel="prefetch" href="./assets/js/40.769847d8.js"><link rel="prefetch" href="./assets/js/5.179c23af.js"><link rel="prefetch" href="./assets/js/6.1bf2641a.js"><link rel="prefetch" href="./assets/js/7.f48746dc.js"><link rel="prefetch" href="./assets/js/vendors~docsearch.68b347c4.js">
    <link rel="stylesheet" href="./assets/css/0.styles.3e8a7b6b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">《JavaScript 权威指南第七版》中文翻译</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/rexhang/rexhang.github.io/ebook/doc-jstdg7" target="_blank" rel="noopener noreferrer" class="repo-link">
    gitee
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/rexhang/rexhang.github.io/ebook/doc-jstdg7" target="_blank" rel="noopener noreferrer" class="repo-link">
    gitee
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/./" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/./ch1.html" class="sidebar-link">Chapter 1. Introduction to JavaScript</a></li><li><a href="/./ch2.html" class="sidebar-link">Chapter 2. Lexical Structure</a></li><li><a href="/./ch3.html" class="sidebar-link">Chapter 3. Types, Values, and Variables</a></li><li><a href="/./ch4.html" class="sidebar-link">Chapter 4. Expressions and Operators</a></li><li><a href="/./ch5.html" class="sidebar-link">Chapter 5. Statements</a></li><li><a href="/./ch6.html" class="sidebar-link">Chapter 6. Objects</a></li><li><a href="/./ch7.html" class="sidebar-link">Chapter 7. Arrays</a></li><li><a href="/./ch8.html" class="sidebar-link">Chapter 8. Functions</a></li><li><a href="/./ch9.html" class="sidebar-link">Chapter 9. Classes</a></li><li><a href="/./ch10.html" class="sidebar-link">Chapter 10. Modules</a></li><li><a href="/./ch11.html" class="sidebar-link">Chapter 11. The JavaScript Standard Library</a></li><li><a href="/./ch12.html" class="sidebar-link">Chapter 12. Iterators and Generators</a></li><li><a href="/./ch13.html" class="sidebar-link">Chapter 13. Asynchronous JavaScript</a></li><li><a href="/./ch14.html" class="sidebar-link">Chapter 14. Metaprogramming</a></li><li><a href="/./ch15.html" class="sidebar-link">Chapter 15. JavaScript in Web Browsers</a></li><li><a href="/./ch16.html" class="sidebar-link">Chapter 16. Server-Side JavaScript with Node</a></li><li><a href="/./ch17.html" aria-current="page" class="active sidebar-link">Chapter 17. JavaScript Tools and Extensions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./ch17.html#_17-1-linting-with-eslint" class="sidebar-link">17.1 Linting with ESLint</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-2-javascript-formatting-with-prettier" class="sidebar-link">17.2 JavaScript Formatting with Prettier</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-3-unit-testing-with-jest" class="sidebar-link">17.3 Unit Testing with Jest</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-4-package-management-with-npm" class="sidebar-link">17.4 Package Management with npm</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-5-code-bundling" class="sidebar-link">17.5 Code Bundling</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-6-transpilation-with-babel" class="sidebar-link">17.6 Transpilation with Babel</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-7-jsx-markup-expressions-in-javascript" class="sidebar-link">17.7 JSX: Markup Expressions in JavaScript</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-type-checking-with-flow" class="sidebar-link">17.8 Type Checking with Flow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-1-installing-and-running-flow" class="sidebar-link">17.8.1 Installing and Running Flow</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-2-using-type-annotations" class="sidebar-link">17.8.2 Using Type Annotations</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-3-class-types" class="sidebar-link">17.8.3 Class Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-4-object-types" class="sidebar-link">17.8.4 Object Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-5-type-aliases" class="sidebar-link">17.8.5 Type Aliases</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-6-array-types" class="sidebar-link">17.8.6 Array Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-7-other-parameterized-types" class="sidebar-link">17.8.7 Other Parameterized Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-8-read-only-types" class="sidebar-link">17.8.8 Read-Only Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-9-function-types" class="sidebar-link">17.8.9 Function Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-10-union-types" class="sidebar-link">17.8.10 Union Types</a></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-8-11-enumerated-types-and-discriminated-unions" class="sidebar-link">17.8.11 Enumerated Types and Discriminated Unions</a></li></ul></li><li class="sidebar-sub-header"><a href="/./ch17.html#_17-9-summary" class="sidebar-link">17.9 Summary</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chapter-17-javascript-tools-and-extensions"><a href="#chapter-17-javascript-tools-and-extensions" class="header-anchor">#</a> Chapter 17. JavaScript Tools and Extensions</h1> <p>Congratulations on reaching the final chapter of this book. If you have read everything that comes before, you now have a detailed understanding of the JavaScript language and know how to use it in Node and in web browsers. This chapter is a kind of graduation present: it introduces a handful of important programming tools that many JavaScript programmers find useful, and also describes two widely used extensions to the core JavaScript language. Whether or not you choose to use these tools and extensions for your own projects, you are almost certain to see them used in other projects, so it is important to at least know what they are.</p> <p>The tools and language extensions covered in this chapter are:</p> <ul><li>ESLint for finding potential bugs and style problems in your code.</li> <li>Prettier for formatting your JavaScript code in a standardized way.</li> <li>Jest as an all-in-one solution for writing JavaScript unit tests.</li> <li>npm for managing and installing the software libraries that your program depends on.</li> <li>Code-bundling tools—like webpack, Rollup, and Parcel—that convert your modules of JavaScript code into a single bundle for use on the web.</li> <li>Babel for translating JavaScript code that uses brand-new language features (or that uses language extensions) into JavaScript code that can run in current web browsers.</li> <li>The JSX language extension (used by the React framework) that allows you to describe user interfaces using JavaScript expressions that look like HTML markup.</li> <li>The Flow language extension (or the similar TypeScript extension) that allows you to annotate your JavaScript code with types and check your code for type safety.</li></ul> <p>This chapter does not document these tools and extensions in any comprehensive way. The goal is simply to explain them in enough depth that you can understand why they are useful and when you might want to use them. Everything covered in this chapter is widely used in the JavaScript programming world, and if you do decide to adopt a tool or extension, you’ll find lots of documentation and tutorials online.</p> <h2 id="_17-1-linting-with-eslint"><a href="#_17-1-linting-with-eslint" class="header-anchor">#</a> 17.1 Linting with ESLint</h2> <p>In programming, the term lint refers to code that, while technically correct, is unsightly, or a possible bug, or suboptimal in some way. A linter is a tool for detecting lint in your code, and linting is the process of running a linter on your code (and then fixing your code to remove the lint so that the linter no longer complains).</p> <p>The most commonly used linter for JavaScript today is ESLint. If you run it and then take the time to actually fix the issues it points out, it will make your code cleaner and less likely to have bugs. Consider the following code:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'unused'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you run ESLint on this code, you might get output like this:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ eslint code<span class="token operator">/</span>ch17<span class="token operator">/</span>linty<span class="token punctuation">.</span>js

code<span class="token operator">/</span>ch17<span class="token operator">/</span>linty<span class="token punctuation">.</span>js
  <span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span>   error    Unexpected <span class="token keyword">var</span><span class="token punctuation">,</span> use <span class="token keyword">let</span> or <span class="token keyword">const</span> instead      no<span class="token operator">-</span><span class="token keyword">var</span>
  <span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span>   error    <span class="token string">'x'</span> is assigned a value but never used        no<span class="token operator">-</span>unused<span class="token operator">-</span>vars
  <span class="token number">1</span><span class="token operator">:</span><span class="token number">9</span>   warning  Strings must use doublequote                  quotes
  <span class="token number">4</span><span class="token operator">:</span><span class="token number">11</span>  error    Expected <span class="token string">'==='</span> and instead saw <span class="token string">'=='</span>           eqeqeq
  <span class="token number">5</span><span class="token operator">:</span><span class="token number">1</span>   error    Expected indentation <span class="token keyword">of</span> <span class="token number">8</span> spaces but found <span class="token number">6</span>  indent
  <span class="token number">7</span><span class="token operator">:</span><span class="token number">28</span>  error    Missing semicolon                             semi

✖ <span class="token number">6</span> <span class="token function">problems</span> <span class="token punctuation">(</span><span class="token number">5</span> errors<span class="token punctuation">,</span> <span class="token number">1</span> warning<span class="token punctuation">)</span>
  <span class="token number">3</span> errors and <span class="token number">1</span> warning potentially fixable <span class="token keyword">with</span> the <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--fix</span><span class="token template-punctuation string">`</span></span> option<span class="token punctuation">.</span>
</code></pre></div><p>Linters can seem nitpicky sometimes. Does it really matter whether we used double quotes or single quotes for our strings? On the other hand, getting indentation right is important for readability, and using === and let instead of == and var protects you from subtle bugs. And unused variables are dead weight in your code—there is no reason to keep those around.</p> <p>ESLint defines many linting rules and has an ecosystem of plug-ins that add many more. But ESLint is fully configurable, and you can define a configuration file that tunes ESLint to enforce exactly the rules you want and only those rules.</p> <h2 id="_17-2-javascript-formatting-with-prettier"><a href="#_17-2-javascript-formatting-with-prettier" class="header-anchor">#</a> 17.2 JavaScript Formatting with Prettier</h2> <p>One of the reasons that some projects use linters is to enforce a consistent coding style so that when a team of programmers is working on a shared codebase, they use compatible code conventions. This includes code indentation rules, but can also include things like what kind of quotation marks are preferred and whether there should be a space between the for keyword and the open parenthesis that follows it.</p> <p>A modern alternative to enforcing code formatting rules via a linter is to adopt a tool like Prettier to automatically parse and reformat all of your code.</p> <p>Suppose you have written the following function, which works, but is formatted unconventionally:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">===</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">}</span>
           <span class="token keyword">else</span><span class="token punctuation">{</span><span class="token keyword">return</span> x<span class="token operator">*</span><span class="token function">factorial</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Running Prettier on this code fixes the indentation, adds missing semicolons, adds spaces around binary operators and inserts line breaks after { and before }, resulting in much more conventional-looking code:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ prettier factorial<span class="token punctuation">.</span>js
<span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you invoke Prettier with the --write option, it will simply reformat the specified file in place rather than printing a reformatted version. If you use git to manage your source code, you can invoke Prettier with the --write option in a commit hook so that code is automatically formatted before being checked in.</p> <p>Prettier is particularly powerful if you configure your code editor to run it automatically every time you save a file. I find it liberating to write sloppy code and see it fixed automatically for me.</p> <p>Prettier is configurable, but it only has a few options. You can select the maximum line length, the indentation amount, whether semicolons should be used, whether strings should be single- or double-quoted, and a few other things. In general, Prettier’s default options are quite reasonable. The idea is that you just adopt Prettier for your project and then never have to think about code formatting again.</p> <p>Personally, I really like using Prettier on JavaScript projects. I have not used it for the code in this book, however, because in much of my code I rely on careful hand formatting to align my comments vertically, and Prettier messes them up.</p> <h2 id="_17-3-unit-testing-with-jest"><a href="#_17-3-unit-testing-with-jest" class="header-anchor">#</a> 17.3 Unit Testing with Jest</h2> <p>Writing tests is an important part of any nontrivial programming project. Dynamic languages like JavaScript support testing frameworks that dramatically reduce the effort required to write tests, and almost make test writing fun! There are a lot of test tools and libraries for JavaScript, and many are written in a modular way so that it is possible to pick one library as your test runner, another library for assertions, and a third for mocking. In this section, however, we’ll describe Jest, which is a popular framework that includes everything you need in a single package.</p> <p>Suppose you’ve written the following function:</p> <p>const getJSON = require(&quot;./getJSON.js&quot;);</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * getTemperature() takes the name of a city as its input, and returns
 * a Promise that will resolve to the current temperature of that city,
 * in degrees Fahrenheit. It relies on a (fake) web service that returns
 * world temperatures in degrees Celsius.
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token parameter">city</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the temperature in Celsius from the web service</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJSON</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://globaltemps.example.com/api/city/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>city<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Convert to Fahrenheit and return that value.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>c <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">;</span>  <span class="token comment">// TODO: double-check this formula</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token constant">A</span> good <span class="token keyword">set</span> <span class="token keyword">of</span> tests <span class="token keyword">for</span> <span class="token keyword">this</span> <span class="token keyword">function</span> might verify that <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is fetching the right <span class="token constant">URL</span><span class="token punctuation">,</span> and that it is converting temperature scales correctly<span class="token punctuation">.</span> We can <span class="token keyword">do</span> <span class="token keyword">this</span> <span class="token keyword">with</span> a Jest<span class="token operator">-</span>based test like the following<span class="token punctuation">.</span> This code defines a mock implementation <span class="token keyword">of</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> so that the test does not actually make a network request<span class="token punctuation">.</span> And because <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is an <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">,</span> the tests are <span class="token keyword">async</span> <span class="token keyword">as</span> well—it can be tricky to test asynchronous functions<span class="token punctuation">,</span> but Jest makes it relatively easy<span class="token operator">:</span>

<span class="token comment">// Import the function we are going to test</span>
<span class="token keyword">const</span> getTemperature <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./getTemperature.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// And mock the getJSON() module that getTemperature() depends on</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&quot;./getJSON&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./getJSON.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Tell the mock getJSON() function to return an already resolved Promise</span>
<span class="token comment">// with fulfillment value 0.</span>
getJSON<span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Our set of tests for getTemperature() begins here</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;getTemperature()&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the first test. We're ensuring that getTemperature() calls</span>
    <span class="token comment">// getJSON() with the URL that we expect</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;Invokes the correct API&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> expectedURL <span class="token operator">=</span> <span class="token string">&quot;https://globaltemps.example.com/api/city/vancouver&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">await</span><span class="token punctuation">(</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token string">&quot;Vancouver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Jest mocks remember how they were called, and we can check that.</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>getJSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span>expectedURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This second test verifies that getTemperature() converts</span>
    <span class="token comment">// Celsius to Fahrenheit correctly</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;Converts C to F correctly&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        getJSON<span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// If getJSON returns 0C</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// We expect 32F</span>

        <span class="token comment">// 100C should convert to 212F</span>
        getJSON<span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// If getJSON returns 100C</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">212</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We expect 212F</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>With the test written, we can use the jest command to run it, and we discover that one of our tests fails:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ jest getTemperature
 <span class="token constant">FAIL</span>  ch17<span class="token operator">/</span>getTemperature<span class="token punctuation">.</span>test<span class="token punctuation">.</span>js
  <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ✓ Invokes the correct <span class="token constant">API</span> <span class="token punctuation">(</span>4ms<span class="token punctuation">)</span>
    ✕ Converts <span class="token constant">C</span> to <span class="token constant">F</span> <span class="token function">correctly</span> <span class="token punctuation">(</span>3ms<span class="token punctuation">)</span>

  ● <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> › Converts <span class="token constant">C</span> to <span class="token constant">F</span> correctly

    <span class="token function">expect</span><span class="token punctuation">(</span>received<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span> <span class="token comment">// Object.is equality</span>

    <span class="token literal-property property">Expected</span><span class="token operator">:</span> <span class="token number">212</span>
    <span class="token literal-property property">Received</span><span class="token operator">:</span> <span class="token number">87.55555555555556</span>

      <span class="token number">29</span> <span class="token operator">|</span>         <span class="token comment">// 100C should convert to 212F</span>
      <span class="token number">30</span> <span class="token operator">|</span>         getJSON<span class="token punctuation">.</span><span class="token function">mockResolvedValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If getJSON returns 100C</span>
    <span class="token operator">&gt;</span> <span class="token number">31</span> <span class="token operator">|</span>         <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">212</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Expect 212F</span>
         <span class="token operator">|</span>                                           <span class="token operator">^</span>
      <span class="token number">32</span> <span class="token operator">|</span>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token number">33</span> <span class="token operator">|</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token number">34</span> <span class="token operator">|</span>

      at Object<span class="token punctuation">.</span><span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>ch17<span class="token operator">/</span>getTemperature<span class="token punctuation">.</span>test<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>

Test Suites<span class="token operator">:</span> <span class="token number">1</span> failed<span class="token punctuation">,</span> <span class="token number">1</span> total
<span class="token literal-property property">Tests</span><span class="token operator">:</span>       <span class="token number">1</span> failed<span class="token punctuation">,</span> <span class="token number">1</span> passed<span class="token punctuation">,</span> <span class="token number">2</span> total
<span class="token literal-property property">Snapshots</span><span class="token operator">:</span>   <span class="token number">0</span> total
<span class="token literal-property property">Time</span><span class="token operator">:</span>        <span class="token number">1</span><span class="token punctuation">.</span>403s
Ran all test suites matching <span class="token operator">/</span>getTemperature<span class="token operator">/</span>i<span class="token punctuation">.</span>
</code></pre></div><p>Our getTemperature() implementation is using the wrong formula for converting C to F. It multiplies by 5 and divides by 9 rather than multiplying by 9 and dividing by 5. If we fix the code and run Jest again, we can see the tests pass. And, as a bonus, if we add the --coverage argument when we invoke jest, it will compute and display the code coverage for our tests:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ jest <span class="token operator">--</span>coverage getTemperature
 <span class="token constant">PASS</span>  ch17<span class="token operator">/</span>getTemperature<span class="token punctuation">.</span>test<span class="token punctuation">.</span>js
  <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ✓ Invokes the correct <span class="token constant">API</span> <span class="token punctuation">(</span>3ms<span class="token punctuation">)</span>
    ✓ Converts <span class="token constant">C</span> to <span class="token constant">F</span> <span class="token function">correctly</span> <span class="token punctuation">(</span>1ms<span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
File              <span class="token operator">|</span> <span class="token operator">%</span> Stmts<span class="token operator">|</span> <span class="token operator">%</span> Branch<span class="token operator">|</span>  <span class="token operator">%</span> Funcs<span class="token operator">|</span>  <span class="token operator">%</span> Lines<span class="token operator">|</span> Uncovered Line #s<span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
All files         <span class="token operator">|</span>   <span class="token number">71.43</span><span class="token operator">|</span>      <span class="token number">100</span><span class="token operator">|</span>    <span class="token number">33.33</span><span class="token operator">|</span>    <span class="token number">83.33</span><span class="token operator">|</span>                  <span class="token operator">|</span>
 getJSON<span class="token punctuation">.</span>js       <span class="token operator">|</span>   <span class="token number">33.33</span><span class="token operator">|</span>      <span class="token number">100</span><span class="token operator">|</span>        <span class="token number">0</span><span class="token operator">|</span>       <span class="token number">50</span><span class="token operator">|</span>                 <span class="token number">2</span><span class="token operator">|</span>
 getTemperature<span class="token punctuation">.</span>js<span class="token operator">|</span>     <span class="token number">100</span><span class="token operator">|</span>      <span class="token number">100</span><span class="token operator">|</span>      <span class="token number">100</span><span class="token operator">|</span>      <span class="token number">100</span><span class="token operator">|</span>                  <span class="token operator">|</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
Test Suites<span class="token operator">:</span> <span class="token number">1</span> passed<span class="token punctuation">,</span> <span class="token number">1</span> total
<span class="token literal-property property">Tests</span><span class="token operator">:</span>       <span class="token number">2</span> passed<span class="token punctuation">,</span> <span class="token number">2</span> total
<span class="token literal-property property">Snapshots</span><span class="token operator">:</span>   <span class="token number">0</span> total
<span class="token literal-property property">Time</span><span class="token operator">:</span>        <span class="token number">1</span><span class="token punctuation">.</span>508s
Ran all test suites matching <span class="token operator">/</span>getTemperature<span class="token operator">/</span>i<span class="token punctuation">.</span>
</code></pre></div><p>Running our test gave us 100% code coverage for the module we were testing, which is exactly what we wanted. It only gave us partial coverage of getJSON(), but we mocked that module and were not trying to test it, so that is expected.</p> <h2 id="_17-4-package-management-with-npm"><a href="#_17-4-package-management-with-npm" class="header-anchor">#</a> 17.4 Package Management with npm</h2> <p>In modern software development, it is common for any nontrivial program that you write to depend on third-party software libraries. If you’re writing a web server in Node, for example, you might be using the Express framework. And if you’re creating a user interface to be displayed in a web browser, you might use a frontend framework like React or LitElement or Angular. A package manager makes it easy to find and install third-party packages like these. Just as importantly, a package manager keeps track of what packages your code depends on and saves this information into a file so that when someone else wants to try your program, they can download your code and your list of dependencies, then use their own package manager to install all the third-party packages that your code needs.</p> <p>npm is the package manager that is bundled with Node, and was introduced in §16.1.5. It is just as useful for client-side JavaScript programming as it is for server-side programming with Node, however.</p> <p>If you are trying out someone else’s JavaScript project, then one of the first things you will often do after downloading their code is to type npm install. This reads the dependencies listed in the package.json file and downloads the third-party packages that the project needs and saves them in a node_modules/ directory.</p> <p>You can also type npm install <code>&lt;package-name&gt;</code> to install a particular package to your project’s node_modules/ directory:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ npm install express
</code></pre></div><p>In addition to installing the named package, npm also makes a record of the dependency in the package.json file for the project. Recording dependencies in this way is what allows others to install those dependencies simply by typing npm install.</p> <p>The other kind of dependency is on developer tools that are needed by developers who want to work on your project, but aren’t actually needed to run the code. If a project uses Prettier, for example, to ensure that all of its code is consistently formatted, then Prettier is a “dev dependency,” and you can install and record one of these with --save-dev:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev prettier
</code></pre></div><p>Sometimes you might want to install developer tools globally so that they are accessible anywhere even for code that is not part of a formal project with a package.json file and a node_modules/ directory. For that you can use the -g (for global) option:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ npm install <span class="token operator">-</span>g eslint jest
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>eslint <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>lib<span class="token operator">/</span>node_modules<span class="token operator">/</span>eslint<span class="token operator">/</span>bin<span class="token operator">/</span>eslint<span class="token punctuation">.</span>js
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>jest <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>lib<span class="token operator">/</span>node_modules<span class="token operator">/</span>jest<span class="token operator">/</span>bin<span class="token operator">/</span>jest<span class="token punctuation">.</span>js
<span class="token operator">+</span> jest@<span class="token number">24.9</span><span class="token number">.0</span>
<span class="token operator">+</span> eslint@<span class="token number">6.7</span><span class="token number">.2</span>
added <span class="token number">653</span> packages from <span class="token number">414</span> contributors <span class="token keyword">in</span> <span class="token number">25</span><span class="token punctuation">.</span>596s

$ which eslint
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>eslint
$ which jest
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>jest
</code></pre></div><p>In addition to the “install” command, npm supports “uninstall” and “update” commands, which do what their names say. npm also has an interesting “audit” command that you can use to find and fix security vulnerabilities in your dependencies:</p> <div class="language-js extra-class"><pre class="language-js"><code>$ npm audit <span class="token operator">--</span>fix

                       <span class="token operator">===</span> npm audit security report <span class="token operator">===</span>

found <span class="token number">0</span> vulnerabilities
 <span class="token keyword">in</span> <span class="token number">876354</span> scanned packages
</code></pre></div><p>When you install a tool like ESLint locally for a project, the eslint script winds up in ./node_modules/.bin/eslint, which makes the command awkward to run. Fortunately, npm is bundled with a command known as “npx,” which you can use to run locally installed tools with commands like npx eslint or npx jest. (And if you use npx to invoke a tool that has not been installed yet, it will install it for you.)</p> <p>The company behind npm also maintains the https://npmjs.com package repository, which holds hundreds of thousands of open source packages. But you don’t have to use the npm package manager to access this repository of packages. Alternatives include yarn and pnpm.</p> <h2 id="_17-5-code-bundling"><a href="#_17-5-code-bundling" class="header-anchor">#</a> 17.5 Code Bundling</h2> <p>If you are writing a large JavaScript program to run in web browsers, you will probably want to use a code-bundling tool, especially if you use external libraries that are delivered as modules. Web developers have been using ES6 modules (§10.3) for years, since well before the import and export keywords were supported on the web. In order to do this, programmers use a code-bundler tool that starts at the main entry point (or entry points) of the program and follows the tree of import directives to find all modules that the program depends on. It then combines all of those individual module files into a single bundle of JavaScript code and rewrites the import and export directives to make the code work in this new form. The result is a single file of code that can be loaded into a web browser that does not support modules.</p> <p>ES6 modules are nearly universally supported by web browsers today, but web developers still tend to use code bundlers, at least when releasing production code. Developers find that user experience is best when a single medium-sized bundle of code is loaded when a user first visits a website than when many small modules are loaded.</p> <h4 id="note"><a href="#note" class="header-anchor">#</a> NOTE</h4> <p>Web performance is a notoriously tricky topic and there are lots of variables to consider, including ongoing improvements by browser vendors, so the only way to be sure of the fastest way to load your code is by testing thoroughly and measuring carefully. Keep in mind that there is one variable that is completely under your control: code size. Less JavaScript code will always load and run faster than more JavaScript code!</p> <p>There are a number of good JavaScript bundler tools available. Commonly used bundlers include webpack, Rollup and Parcel. The basic features of bundlers are more or less the same, and they are differentiated based on how configurable they are or how easy they are to use. Webpack has been around for a long time, has a large ecosystem of plug-ins, is highly configurable, and can support older nonmodule libraries. But it can also be complex and hard to configure. At the other end of the spectrum is Parcel which is intended as a zero-configuration alternative that simply does the right thing.</p> <p>In addition to performing basic bundling, bundler tools can also provide some additional features:</p> <ul><li>Some programs have more than one entry point. A web application with multiple pages, for example, could be written with a different entry point for each page. Bundlers generally allow you to create one bundle per entry point or to create a single bundle that supports multiple entry points.</li> <li>Programs can use import() in its functional form (§10.3.6) instead of its static form to dynamically load modules when they are actually needed rather than statically loading them at program startup time. Doing this is often a good way to improve the startup time for your program. Bundler tools that support import() may be able to produce multiple output bundles: one to load at startup time, and one or more that are loaded dynamically when needed. This can work well if there are only a few calls to import() in your program and they load modules with relatively disjoint sets of dependencies. If the dynamically loaded modules share dependencies then it becomes tricky to figure out how many bundles to produce, and you are likely to have to manually configure your bundler to sort this out.</li> <li>Bundlers can generally output a source map file that defines a mapping between the lines of code in the bundle and the corresponding lines in the original source files. This allows browser developer tools to automatically display JavaScript errors at their original unbundled locations.</li> <li>Sometimes when you import a module into your program, you only use a few of its features. A good bundler tool can analyze the code to determine which parts are unused and can be omitted from the bundles. This feature goes by the whimsical name of “tree-shaking.”</li> <li>Bundlers typically have a plug-in–based architecture and support plug-ins that allow importing and bundling “modules” that are not actually files of JavaScript code. Suppose that your program includes a large JSON-compatible data structure. Code bundlers can be configured to allow you to move that data structure into a separate JSON file and then import it into your program with a declaration like import widgets from &quot;./big-widget-list.json&quot;. Similarly, web developers who embed CSS into their JavaScript programs can use bundler plug-ins that allow them to import CSS files with an import directive. Note, however, that if you import anything other than a JavaScript file, you are using a nonstandard JavaScript extension and making your code dependent on the bundler tool.</li> <li>In a language like JavaScript that does not require compilation, running a bundler tool feels like a compilation step, and it is frustrating to have to run a bundler after every code edit before you can run the code in your browser. Bundlers typically support filesystem watchers that detect edits to any files in a project directory and automatically regenerate the necessary bundles. With this feature in place you can typically save your code and then immediately reload your web browser window to try it out.</li> <li>Some bundlers also support a “hot module replacement” mode for developers where each time a bundle is regenerated, it is automatically loaded into the browser. When this works, it is a magical experience for developers, but there are some tricks going on under the hood to make it work, and it is not suitable for all projects.</li></ul> <h2 id="_17-6-transpilation-with-babel"><a href="#_17-6-transpilation-with-babel" class="header-anchor">#</a> 17.6 Transpilation with Babel</h2> <p>Babel is a tool that compiles JavaScript written using modern language features into JavaScript that does not use those modern language features. Because it compiles JavaScript to JavaScript, Babel is sometimes called a “transpiler.” Babel was created so that web developers could use the new language features of ES6 and later while still targeting web browsers that only supported ES5.</p> <p>Language features such as the ** exponentiation operator and arrow functions can be transformed relatively easily into Math.pow() and function expressions. Other language features, such as the class keyword, require much more complex transformations, and, in general, the code output by Babel is not meant to be human readable. Like bundler tools, however, Babel can produce source maps that map transformed code locations back to their original source locations, and this helps dramatically when working with transformed code.</p> <p>Browser vendors are doing a better job of keeping up with the evolution of the JavaScript language, and there is much less need today to compile away arrow functions and class declarations. Babel can still help when you want to use the very latest features like underscore separators in numeric literals.</p> <p>Like most of the other tools described in this chapter, you can install Babel with npm and run it with npx. Babel reads a .babelrc configuration file that tells it how you would like your JavaScript code transformed. Babel defines “presets” that you can choose from depending on which language extensions you want to use and how aggressively you want to transform standard language features. One of Babel’s interesting presets is for code compression by minification (stripping comments and whitespace, renaming variables, and so on).</p> <p>If you use Babel and a code-bundling tool, you may be able to set up the code bundler to automatically run Babel on your JavaScript files as it builds the bundle for you. If so, this can be a convenient option because it simplifies the process of producing runnable code. Webpack, for example, supports a “babel-loader” module that you can install and configure to run Babel on each JavaScript module as it is bundled up.</p> <p>Even though there is less need to transform the core JavaScript language today, Babel is still commonly used to support nonstandard extensions to the language, and we’ll describe two of these language extensions in the sections that follow.</p> <h2 id="_17-7-jsx-markup-expressions-in-javascript"><a href="#_17-7-jsx-markup-expressions-in-javascript" class="header-anchor">#</a> 17.7 JSX: Markup Expressions in JavaScript</h2> <p>JSX is an extension to core JavaScript that uses HTML-style syntax to define a tree of elements. JSX is most closely associated with the React framework for user interfaces on the web. In React, the trees of elements defined with JSX are ultimately rendered into a web browser as HTML. Even if you have no plans to use React yourself, its popularity means that you are likely to see code that uses JSX. This section explains what you need to know to make sense of of it. (This section is about the JSX language extension, not about React, and it explains only enough of React to provide context for the JSX syntax.)</p> <p>You can think of a JSX element as a new type of JavaScript expression syntax. JavaScript string literals are delimited with quotation marks, and regular expression literals are delimited with slashes. In the same way, JSX expression literals are delimited with angle brackets. Here is a very simple one:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> line <span class="token operator">=</span> <span class="token operator">&lt;</span>hr<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>If you use JSX, you will need to use Babel (or a similar tool) to compile JSX expressions into regular JavaScript. The transformation is simple enough that some developers choose to use React without using JSX. Babel transforms the JSX expression in this assignment statement into a simple function call:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> line <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;hr&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>JSX syntax is HTML-like, and like HTML elements, React elements can have attributes like these:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;logo.png&quot;</span> alt<span class="token operator">=</span><span class="token string">&quot;The JSX logo&quot;</span> hidden<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>When an element has one or more attributes, they become properties of an object passed as the second argument to createElement():</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> image <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">&quot;logo.png&quot;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">alt</span><span class="token operator">:</span> <span class="token string">&quot;The JSX logo&quot;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">hidden</span><span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Like HTML elements, JSX elements can have strings and other elements as children. Just as JavaScript’s arithmetic operators can be used to write arithmetic expressions of arbitrary complexity, JSX elements can also be nested arbitrarily deeply to create trees of elements:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sidebar <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;sidebar&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Title<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>hr<span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>This is the sidebar content<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Regular JavaScript function call expressions can also be nested arbitrarily deeply, and these nested JSX expressions translate into a set of nested createElement() calls. When an JSX element has children, those children (which are typically strings and other JSX elements) are passed as the third and subsequent arguments:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sidebar <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">&quot;sidebar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">// This outer call creates a &lt;div&gt;</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token comment">// This is the first child of the &lt;div/&gt;</span>
                        <span class="token string">&quot;Title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// and its own first child.</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;hr&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// The second child of the &lt;div/&gt;.</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>   <span class="token comment">// And the third child.</span>
                        <span class="token string">&quot;This is the sidebar content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The value returned by React.createElement() is an ordinary JavaScript object that is used by React to render output in a browser window. Since this section is about the JSX syntax and not about React, we’re not going to go into any detail about the returned Element objects or the rendering process. It is worth noting that you can configure Babel to compile JSX elements to invocations of a different function, so if you think that JSX syntax would be a useful way to express other kinds of nested data structures, you can adopt it for your own non-React uses.</p> <p>An important feature of JSX syntax is that you can embed regular JavaScript expressions within JSX expressions. Within a JSX expression, text within curly braces is interpreted as plain JavaScript. These nested expressions are allowed as attribute values and as child elements. For example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sidebar</span><span class="token punctuation">(</span><span class="token parameter">className<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">,</span> drawLine<span class="token operator">=</span><span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span> drawLine <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>hr<span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The sidebar() function returns a JSX element. It takes four arguments that it uses within the JSX element. The curly brace syntax may remind you of template literals that use ${} to include JavaScript expressions within strings. Since we know that JSX expressions compile into function invocations, it should not be surprising that arbitrary JavaScript expressions can be included because function invocations can be written with arbitrary expressions as well. This example code is translated by Babel into the following:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sidebar</span><span class="token punctuation">(</span><span class="token parameter">className<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">,</span> drawLine<span class="token operator">=</span><span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">className</span><span class="token operator">:</span> className <span class="token punctuation">}</span><span class="token punctuation">,</span>
                             React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">,</span>
                             drawLine <span class="token operator">&amp;&amp;</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;hr&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This code is easy to read and understand: the curly braces are gone and the resulting code passes the incoming function parameters to React.createElement() in a natural way. Note the neat trick that we’ve done here with the drawLine parameter and the short-circuiting &amp;&amp; operator. If you call sidebar() with only three arguments, then drawLine defaults to true, and the fourth argument to the outer createElement() call is the <code>&lt;hr/&gt;</code> element. But if you pass false as the fourth argument to sidebar(), then the fourth argument to the outer createElement() call evaluates to false, and no <code>&lt;hr/&gt;</code> element is ever created. This use of the &amp;&amp; operator is a common idiom in JSX to conditionally include or exclude a child element depending on the value of some other expression. (This idiom works with React because React simply ignores children that are false or null and does not produce any output for them.)</p> <p>When you use JavaScript expressions within JSX expressions, you are not limited to simple values like the string and boolean values in the preceding example. Any JavaScript value is allowed. In fact, it is quite common in React programming to use objects, arrays, and functions. Consider the following function, for example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Given an array of strings and a callback function return a JSX element</span>
<span class="token comment">// representing an HTML &lt;ul&gt; list with an array of &lt;li&gt; elements as its child.</span>
<span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token parameter">items<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul style<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token punctuation">{</span><span class="token literal-property property">padding</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">border</span><span class="token operator">:</span><span class="token string">&quot;solid red 4px&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;</span>li onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span> key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This function uses an object literal as the value of the style attribute on the <code>&lt;ul&gt;</code> element. (Note that double curly braces are required here.) The <code>&lt;ul&gt;</code> element has a single child, but the value of that child is an array. The child array is the array created by using the map() function on the input array to create an array of <code>&lt;li&gt;</code> elements. (This works with React because the React library flattens the children of an element when it renders them. An element with one array child is the same as that element with each of those array elements as children.) Finally, note that each of the nested <code>&lt;li&gt;</code> elements has an onClick event handler attribute whose value is an arrow function. The JSX code compiles to the following pure JavaScript code (which I have formatted with Prettier):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token parameter">items<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    <span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token string">&quot;solid red 4px&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
        <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> index <span class="token punctuation">}</span><span class="token punctuation">,</span>
        item
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>One other use of object expressions in JSX is with the object spread operator (§6.10.4) to specify multiple attributes at once. Suppose that you find yourself writing a lot of JSX expressions that repeat a common set of attributes. You can simplify your expressions by defining the attributes as properties of an object and “spreading them into” your JSX elements:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> hebrew <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">lang</span><span class="token operator">:</span> <span class="token string">&quot;he&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">dir</span><span class="token operator">:</span> <span class="token string">&quot;rtl&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Specify language and direction</span>
<span class="token keyword">let</span> shalom <span class="token operator">=</span> <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token string">&quot;emphasis&quot;</span> <span class="token punctuation">{</span><span class="token operator">...</span>hebrew<span class="token punctuation">}</span><span class="token operator">&gt;</span>שלום<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token punctuation">;</span>
Babel compiles <span class="token keyword">this</span> to use an <span class="token function">_extends</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">omitted here</span><span class="token punctuation">)</span> that combines that className attribute <span class="token keyword">with</span> the attributes contained <span class="token keyword">in</span> the hebrew object<span class="token operator">:</span>

<span class="token keyword">let</span> shalom <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span>
                                 <span class="token function">_extends</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">&quot;emphasis&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> hebrew<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 <span class="token string">&quot;\u05E9\u05DC\u05D5\u05DD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally, there is one more important feature of JSX that we have not covered yet. As you’ve seen, all JSX elements begin with an identifier immediately after the opening angle bracket. If the first letter of this identifier is lowercase (as it has been in all of the examples here), then the identifier is passed to createElement() as a string. But if the first letter of the identifier is uppercase, then it is treated as an actual identifer, and it is the JavaScript value of that identifier that is passed as the first argument to createElement(). This means that the JSX expression <code>&lt;Math/&gt;</code> compiles to JavaScript code that passes the global Math object to React.createElement().</p> <p>For React, this ability to pass non-string values as the first argument to createElement() enables the creation of components. A component is a way of writing a simple JSX expression (with an uppercase component name) that represents a more complex expression (using lowercase HTML tag names).</p> <p>The simplest way to define a new component in React is to write a function that takes a “props object” as its argument and returns a JSX expression. A props object is simply a JavaScript object that represents attribute values, like the objects that are passed as the second argument to createElement(). Here, for example, is another take on our sidebar() function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Sidebar</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span> props<span class="token punctuation">.</span>drawLine <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>hr<span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This new Sidebar() function is a lot like the earlier sidebar() function. But this one has a name that begins with a capital letter and takes a single object argument instead of separate arguments. This makes it a React component and means that it can be used in place of an HTML tag name in JSX expressions:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sidebar <span class="token operator">=</span> <span class="token operator">&lt;</span>Sidebar title<span class="token operator">=</span><span class="token string">&quot;Something snappy&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;Something wise&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
This <span class="token operator">&lt;</span>Sidebar<span class="token operator">/</span><span class="token operator">&gt;</span> element compiles like <span class="token keyword">this</span><span class="token operator">:</span>

<span class="token keyword">let</span> sidebar <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Sidebar<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;Something snappy&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&quot;Something wise&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It is a simple JSX expression, but when React renders it, it will pass the second argument (the Props object) to the first argument (the Sidebar() function) and will use the JSX expression returned by that function in place of the <code>&lt;Sidebar&gt;</code> expression.</p> <h2 id="_17-8-type-checking-with-flow"><a href="#_17-8-type-checking-with-flow" class="header-anchor">#</a> 17.8 Type Checking with Flow</h2> <p>Flow is a language extension that allows you to annotate your JavaScript code with type information, and a tool for checking your JavaScript code (both annotated and unannotated) for type errors. To use Flow, you start writing code using the Flow language extension to add type annotations. Then you run the Flow tool to analyze your code and report type errors. Once you have fixed the errors and are ready to run the code, you use Babel (perhaps automatically as part of the code-bundling process) to strip the Flow type annotations out of your code. (One of the nice things about the Flow language extension is that there isn’t any new syntax that Flow has to compile or transform. You use the Flow language extension to add annotations to the code, and all Babel has to do is to strip those annotations out to return your code to standard JavaScript.)</p> <h4 id="typescript-versus-flow"><a href="#typescript-versus-flow" class="header-anchor">#</a> TYPESCRIPT VERSUS FLOW</h4> <p>TypeScript is a very popular alternative to Flow. TypeScript is an extension of JavaScript that adds types as well as other language features. The TypeScript compiler “tsc” compiles TypeScript programs into JavaScript programs and in the process analyzes them and reports type errors in much the same the way that Flow does. tsc is not a Babel plugin: it is its own standalone compiler.</p> <p>Simple type annotations in TypeScript are usually written identically to the same annotations in Flow. For more advanced typing, the syntax of the two extensions diverges, but the intent and value of the two extensions is the same. My goal in this section is to explain the benefits of type annotations and static code analysis. I’ll be doing that with examples based on Flow, but everything demonstrated here can also be achieved with TypeScript with relatively simple syntax changes.</p> <p>TypeScript was released in 2012, before ES6, when JavaScript did not have a class keyword or a for/of loop or modules or Promises. Flow is a narrow language extension that adds type annotations to JavaScript and nothing else. TypeScript, by contrast, was very much designed as a new language. As its name implies, adding types to JavaScript is the primary purpose of TypeScript, and it is the reason that people use it today. But types are not the only feature that TypeScript adds to JavaScript: the TypeScript language has enum and namespace keywords that simply do not exist in JavaScript. In 2020, TypeScript has better integration with IDEs and code editors (particularly VSCode, which, like TypeScript, is from Microsoft) than Flow does.</p> <p>Ultimately, this is a book about JavaScript, and I’m covering Flow here instead of TypeScript because I don’t want to take the focus off of JavaScript. But everything you learn here about adding types to JavaScript will be helpful to you if you decide to adopt TypeScript for your projects.</p> <p>Using Flow requires commitment, but I have found that for medium and large projects, the extra effort is worth it. It takes extra time to add type annotations to your code, to run Flow every time you edit the code, and to fix the type errors it reports. But in return Flow will enforce good coding discipline and will not allow you to cut corners that can lead to bugs. When I have worked on projects that use Flow, I have been impressed by the number of errors it found in my own code. Being able to fix those issues before they became bugs is a great feeling and gives me extra confidence that my code is correct.</p> <p>When I first started using Flow, I found that it was sometimes difficult to understand why it was complaining about my code. With some practice, though, I came to understand its error messages and found that it was usually easy to make minor changes to my code to make it safer and to satisfy Flow.1 I do not recommend using Flow if you still feel like you are learning JavaScript itself. But once you are confident with the language, adding Flow to your JavaScript projects will push you to take your programming skills to the next level. And this, really, is why I’m dedicating the last section of this book to a Flow tutorial: because learning about JavaScript type systems offers a glimpse of another level, or another style, of programming.</p> <p>This section is a tutorial, and it does not attempt to cover Flow comprehensively. If you decide to try Flow, you will almost certainly end up spending time reading the documentation at https://flow.org. On the other hand, you do not need to master the Flow type system before you can start making practical use of it in your projects: the simple uses of Flow described here will take you a long way.</p> <h3 id="_17-8-1-installing-and-running-flow"><a href="#_17-8-1-installing-and-running-flow" class="header-anchor">#</a> 17.8.1 Installing and Running Flow</h3> <p>Like the other tools described in this chapter, you can install the Flow type-checking tool using a package manager, with a command like npm install -g flow-bin or npm install --save-dev flow-bin. If you install the tool globally with -g, then you can run it with flow. And if you install it locally in your project with --save-dev, then you can run it with npx flow. Before using Flow to do type checking, the first time run it as flow --init in the root directory of your project to create a .flowconfig configuration file. You may never need to add anything to this file, but Flow needs it to know where your project root is.</p> <p>When you run Flow, it will find all the JavaScript source code in your project, but it will only report type errors for the files that have “opted in” to type checking by adding a // @flow comment at the top of the file. This opt-in behavior is important because it means that you can adopt Flow for existing projects and then begin to convert your code one file at a time, without being bothered by errors and warnings on files that have not yet been converted.</p> <p>Flow may be able to find errors in your code even if all you do is opt in with a // @flow comment. Even if you do not use the Flow language extension and add no type annotations to your code, the Flow type checker tool can still make inferences about the values in your program and alert you when you use them inconsistently.</p> <p>Consider the following Flow error message:</p> <div class="language-js extra-class"><pre class="language-js"><code>Error ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ variableReassignment<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">3</span>

Cannot assign <span class="token number">1</span> to i<span class="token punctuation">.</span>r because<span class="token operator">:</span>
 • property r is missing <span class="token keyword">in</span> number <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

     <span class="token number">2</span>│ <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">i</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// The complex number 0+1i</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">3</span>│ <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Oops! The loop variable overwrites i</span>
     <span class="token number">4</span>│     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token number">5</span>│ <span class="token punctuation">}</span>
     <span class="token number">6</span>│ i<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">// Flow detects the error here</span>
</code></pre></div><p>In this case, we declare the variable i and assign an object to it. Then we use i again as a loop variable, overwriting the object. Flow notices this and flags an error when we try to use i as if it still held an object. (A simple fix would be to write for(let i = 0; making the loop variable local to the loop.)</p> <p>Here is another error that Flow detects even without type annotations:</p> <div class="language-js extra-class"><pre class="language-js"><code>Error ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ size<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">14</span>

Cannot <span class="token keyword">get</span> x<span class="token punctuation">.</span>length because property length is missing <span class="token keyword">in</span> Number <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

     <span class="token number">1</span>│ <span class="token comment">// @flow</span>
     <span class="token number">2</span>│ <span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token number">3</span>│     <span class="token keyword">return</span> x<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
     <span class="token number">4</span>│ <span class="token punctuation">}</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">5</span>│ <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Flow sees that the size() function takes a single argument. It doesn’t know the type of that argument, but it can see that the argument is expected to have a length property. When it sees this size() function being called with a numeric argument, it correctly flags this as an error because numbers do not have length properties.</p> <h3 id="_17-8-2-using-type-annotations"><a href="#_17-8-2-using-type-annotations" class="header-anchor">#</a> 17.8.2 Using Type Annotations</h3> <p>When you declare a JavaScript variable, you can add a Flow type annotation to it by following the variable name with a colon and the type:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token literal-property property">message</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token literal-property property">flag</span><span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token literal-property property">n</span><span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre></div><p>Flow would know the types of these variables even if you did not annotate them: it can see what values you assign to each variable, and it keeps track of that. If you add type annotations, however, Flow knows both the type of the variable and that you have expressed the intent that the variable should always be of that type. So if you use the type annotation, Flow will flag an error if you ever assign a value of a different type to that variable. Type annotations for variables are also particularly useful if you tend to declare all your variables up at the top of a function before they are used.</p> <p>Type annotations for function arguments are like annotations for variables: follow the name of the function argument with a colon and the type name. When annotating a function, you typically also add an annotation for the return type of the function. This goes between the close parenthesis and the open curly brace of the function body. Functions that return nothing use the Flow type void.</p> <p>In the preceding example we defined a size() function that expected an argument with a length property. Here’s how we could change that function to explicitly specify that it expects a string argument and returns a number. Note, Flow now flags an error if we pass an array to the function, even though the function would work in that case:</p> <div class="language-js extra-class"><pre class="language-js"><code>Error ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ size2<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">18</span>

Cannot call size <span class="token keyword">with</span> array literal bound to s because array literal <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
is incompatible <span class="token keyword">with</span> string <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

 <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token number">2</span>│ <span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
     <span class="token number">3</span>│     <span class="token keyword">return</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
     <span class="token number">4</span>│ <span class="token punctuation">}</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">5</span>│ console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Using type annotations with arrow functions is also possible, though it can turn this normally succinct syntax into something more verbose:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">number</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
</code></pre></div><p>An important thing to understand about Flow is that the JavaScript value null has the Flow type null and the JavaScript value undefined has the Flow type void. But neither of these values is a member of any other type (unless you explicitly add it). If you declare a function parameter to be a string, then it must be a string, and it is an error to pass null or to pass undefined or to omit the argument (which is basically the same thing as passing undefined):</p> <div class="language-js extra-class"><pre class="language-js"><code>Error ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ size3<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">18</span>

Cannot call size <span class="token keyword">with</span> <span class="token keyword">null</span> bound to s because <span class="token keyword">null</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> is incompatible
<span class="token keyword">with</span> string <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

     <span class="token number">1</span>│ <span class="token comment">// @flow</span>
 <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token number">2</span>│ <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">number</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">3</span>│ console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you want to allow null and undefined as legal values for a variable or function argument, simply prefix the type with a question mark. For example, use ?string or ?number instead of string or number. If we change our size() function to expect an argument of type ?string, then Flow doesn’t complain when we pass null to the function. But it now has something else to complain about:</p> <div class="language-js extra-class"><pre class="language-js"><code>Error ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ size4<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">14</span>

Cannot <span class="token keyword">get</span> s<span class="token punctuation">.</span>length because property length is missing <span class="token keyword">in</span> <span class="token keyword">null</span> or
<span class="token keyword">undefined</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

     <span class="token number">1</span>│ <span class="token comment">// @flow</span>
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">2</span>│ <span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
     <span class="token number">3</span>│     <span class="token keyword">return</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
     <span class="token number">4</span>│ <span class="token punctuation">}</span>
     <span class="token number">5</span>│ console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>What Flow is telling us here is that it is not safe to write s.length because, at this place in our code, s might be null or undefined, and those values do not have length properties. This is where Flow makes sure we do not cut any corners. If a value might be null, Flow will insist that we check for that case before we do anything that depends on the value not being null.</p> <p>In this case, we can fix the issue by changing the body of the function as follows:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token comment">// At this point in the code, s could be a string or null or undefined.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> s <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// In this block, Flow knows that s is null or undefined.</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// And in this block, Flow knows that s is a string.</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the function is first called, the parameter can have more than one type. But by adding type-checking code, we create a block within the code where Flow knows for sure that the parameter is a string. When we use s.length within that block, Flow does not complain. Note that Flow does not require you to write verbose code like this. Flow would also be satisfied if we just replaced the body of the size() function with return s ? s.length : -1;.</p> <p>Flow syntax allows a question mark before any type specification to indicate that, in addition to the specified type, null and undefined are allowed as well. Question marks can also appear after a parameter name to indicate that the parameter itself is optional. So if we changed the declaration of the parameter s from s: ?string to s? : string, that would mean it is OK to call size() with no arguments (or with the value undefined, which is the same as omitting it), but that if we do call it with a parameter other than undefined, then that parameter must be a string. In this case, null is not a legal value.</p> <p>So far, we’ve discussed primitive types string, number, boolean, null, and void and have demonstrated how you can use use them with variable declarations, function parameters, and function return values. The subsections that follow describe some more complex types supported by Flow.</p> <h3 id="_17-8-3-class-types"><a href="#_17-8-3-class-types" class="header-anchor">#</a> 17.8.3 Class Types</h3> <p>In addition to the primitive types that Flow knows about, it also knows about all of JavaScript’s built-in classes and allows you to use class name as types. The following function, for example, uses type annotations to indicate that it should be invoked with one Date object and one RegExp object:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token comment">// Return true if the ISO representation of the specified date</span>
<span class="token comment">// matches the specified pattern, or false otherwise.</span>
<span class="token comment">// E.g: const isTodayChristmas = dateMatches(new Date(), /^\d{4}-12-25T/);</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">dateMatches</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">d</span><span class="token operator">:</span> Date<span class="token punctuation">,</span> <span class="token literal-property property">p</span><span class="token operator">:</span> RegExp</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you define your own classes with the class keyword, those classes automatically become valid Flow types. In order to make this work, however, Flow does require you to use type annotations in the class. In particular, each property of the class must have its type declared. Here is a simple complex number class that demonstrates this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Complex</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flow requires an extended class syntax that includes type annotations</span>
    <span class="token comment">// for each of the properties used by the class.</span>
    <span class="token literal-property property">i</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
    <span class="token literal-property property">r</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token literal-property property">i</span><span class="token operator">:</span> Complex<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">r</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">i</span><span class="token operator">:</span>number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Any properties initialized by the constructor must have Flow type</span>
        <span class="token comment">// annotations above.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">that</span><span class="token operator">:</span> Complex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Complex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>r <span class="token operator">+</span> that<span class="token punctuation">.</span>r<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">+</span> that<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// This assignment would not be allowed by Flow if there was not a</span>
<span class="token comment">// type annotation for i inside the class.</span>
Complex<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Complex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_17-8-4-object-types"><a href="#_17-8-4-object-types" class="header-anchor">#</a> 17.8.4 Object Types</h3> <p>The Flow type to describe an object looks a lot like an object literal, except that property values are replaced by property types. Here, for example, is a function that expects an object with numeric x and y properties:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token comment">// Given an object with numeric x and y properties, return the</span>
<span class="token comment">// distance from the origin to the point (x,y) as a number.</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">point</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span>number<span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span>number<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">hypot</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> point<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In this code, the text {x:number, y:number} is a Flow type, just like string or Date is. As with any type, you can add a question mark at the front to indicate that null and undefined should also be allowed.</p> <p>Within an object type, you can follow any of the property names with a question mark to indicate that that property is optional and may be omitted. For example, you might write the type for an object that represents a 2D or 3D point like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> number<span class="token punctuation">,</span> z<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">}</span>
</code></pre></div><p>If a property is not marked as optional in an object type, then it is required, and Flow will report an error if an appropriate property is not present in the actual value. Normally, however, Flow tolerates extra properties. If you were to pass an object that had a w property to the distance() function above, Flow would not complain.</p> <p>If you want Flow to strictly enforce that an object does not have properties other than those explicitly declared in its type, you can declare an exact object type by adding vertical bars to the curly braces:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token operator">|</span> x<span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> number <span class="token operator">|</span><span class="token punctuation">}</span>
</code></pre></div><p>JavaScript’s objects are sometimes used as dictionaries or string-to-value maps. When used like this, the property names are not known in advance and cannot be declared in a Flow type. If you use objects this way, you can still use Flow to describe the data structure. Suppose that you have an object where the properties are the names of the world’s major cities and the values of those properties are objects that specify the geographical location of those cities. You might declare this data structure like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">const</span> <span class="token literal-property property">cityLocations</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>string<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">longitude</span><span class="token operator">:</span>number<span class="token punctuation">,</span> <span class="token literal-property property">latitude</span><span class="token operator">:</span>number<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;Seattle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">longitude</span><span class="token operator">:</span> <span class="token number">47.6062</span><span class="token punctuation">,</span> <span class="token literal-property property">latitude</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">122.3321</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: if there are any other important cities, add them here.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> cityLocations<span class="token punctuation">;</span>
</code></pre></div><h3 id="_17-8-5-type-aliases"><a href="#_17-8-5-type-aliases" class="header-anchor">#</a> 17.8.5 Type Aliases</h3> <p>Objects can have many properties, and the Flow type that describes such an object will be long and difficult to type. And even relatively short object types can be confusing because they look so much like object literals. Once we get beyond simple types like number and ?string, it is often useful to be able to define names for our Flow types. And in fact, Flow uses the type keyword to do exactly that. Follow the type keyword with an identifier, an equals sign, and a Flow type. Once you’ve done that, the identifier will be an alias for the type. Here, for example, is how we could rewrite the distance() function from the previous section with an explicitly defined Point type:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">export</span> type Point <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> number
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Given a Point object return its distance from the origin</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">point</span><span class="token operator">:</span> Point</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">hypot</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">,</span> point<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note that this code exports the distance() function and also exports the Point type. Other modules can use import type Point from './distance.js' if they want to use that type definition. Keep in mind, though, that import type is a Flow language extension and not a real JavaScript import directive. Type imports and exports are used by the Flow type checker, but like all other Flow language extensions, they are stripped out of the code before it ever runs.</p> <p>Finally, it is worth noting that instead of defining a name for a Flow object type that represents a point, it would probably be simpler and cleaner to just define a Point class and use that class as the type.</p> <h3 id="_17-8-6-array-types"><a href="#_17-8-6-array-types" class="header-anchor">#</a> 17.8.6 Array Types</h3> <p>The Flow type to describe an array is a compound type that also includes the type of the array elements. Here, for example, is a function that expects an array of numbers, and the error that Flow reports if you try to call the function with an array that has non-numeric elements:</p> <div class="language-js extra-class"><pre class="language-js"><code>Error ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ average<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token number">16</span>

Cannot call average <span class="token keyword">with</span> array literal bound to data because string <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
is incompatible <span class="token keyword">with</span> number <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">in</span> array element<span class="token punctuation">.</span>

 <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token number">2</span>│ <span class="token keyword">function</span> <span class="token function">average</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">data</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token number">3</span>│     <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token number">4</span>│     <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token keyword">of</span> data<span class="token punctuation">)</span> sum <span class="token operator">+=</span> x<span class="token punctuation">;</span>
      <span class="token number">5</span>│     <span class="token keyword">return</span> sum<span class="token operator">/</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token number">6</span>│ <span class="token punctuation">}</span>
      <span class="token number">7</span>│
 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token number">8</span>│ <span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;three&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The Flow type for an array is Array followed by the element type in angle brackets. You can also express an array type by following the element type with open and close square brackets. So in this example we could have written number[] instead of <code>Array&lt;number&gt;</code>. I prefer the angle bracket notation because, as we’ll see, there are other Flow types that use this angle-bracket syntax.</p> <p>The Array type syntax shown works for arrays with an arbitrary number of elements, all of which have the same type. Flow has a different syntax for describing the type of a tuple: an array with a fixed number of elements, each of which may have a different type. To express the type of a tuple, simply write the type of each of its elements, separate them with commas, and enclose them all in square brackets.</p> <p>A function that returns an HTTP status code and message might look like this, for example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">[</span>number<span class="token punctuation">,</span> string<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getStatusMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Functions that return tuples are awkward to work with unless you use destructuring assignment:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">[</span>code<span class="token punctuation">,</span> message<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Destructuring assignment, plus Flow’s type-aliasing capabilities, make tuples easy enough to work with that you might consider them as an alternative to classes for simple datatypes:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">export</span> type Color <span class="token operator">=</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> number<span class="token punctuation">,</span> number<span class="token punctuation">,</span> number<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// [r, g, b, opacity]</span>

<span class="token keyword">function</span> <span class="token function">gray</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">level</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> Color <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>level<span class="token punctuation">,</span> level<span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fade</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>r<span class="token punctuation">,</span>g<span class="token punctuation">,</span>b<span class="token punctuation">,</span>a<span class="token punctuation">]</span><span class="token operator">:</span> Color<span class="token punctuation">,</span> <span class="token literal-property property">factor</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> Color <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token operator">/</span>factor<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fade</span><span class="token punctuation">(</span><span class="token function">gray</span><span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now that we have a way to express the type of an array, let’s return to the size() function from earlier and modify it to expect an array argument instead of a string argument. We want the function to be able to accept an array of any length, so a tuple type is not appropriate. But we don’t want to restrict our function to working only for arrays where all the elements have the same type. The solution is the type <code>Array&lt;mixed&gt;</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">&quot;three&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The element type mixed indicates that the elements of the array can be of any type. If our function actually indexed the array and attempted to use any of those elements, Flow would insist that we use typeof checks or other tests to determine the type of the element before performing any unsafe operation on it. (If you are willing to give up on type checking, you can also use any instead of mixed: it allows you to do whatever you want with the values of the array without ensuring that the values are of the type you expect.)</p> <h3 id="_17-8-7-other-parameterized-types"><a href="#_17-8-7-other-parameterized-types" class="header-anchor">#</a> 17.8.7 Other Parameterized Types</h3> <p>We’ve seen that when you annotate a value as an Array, Flow requires you to also specify the type of the array elements inside angle brackets. This additional type is known as a type parameter, and Array is not the only JavaScript class that is parameterized.</p> <p>JavaScript’s Set class is a collection of elements, like an array is, and you can’t use Set as a type by itself, but you have to include a type parameter within angle brackets to specify the type of the values contained in the set. (Though you can use mixed or any if the set may contain values of multiple types.) Here’s an example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token comment">// Return a set of numbers with members that are exactly twice those</span>
<span class="token comment">// of the input set of numbers.</span>
<span class="token keyword">function</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">s</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token literal-property property">doubled</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> n <span class="token keyword">of</span> s<span class="token punctuation">)</span> doubled<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> doubled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Prints &quot;Set {2, 4, 6}&quot;</span>
</code></pre></div><p>Map is another parameterized type. In this case, there are two type parameters that must be specified; the type of the keys and the types of the values:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">import</span> type <span class="token punctuation">{</span> Color <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Color.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token literal-property property">colorNames</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Color<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;green&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Flow lets you define type parameters for your own classes as well. The following code defines a Result class but parameterizes that class with an Error type and a Value type. We use placeholders E and V in the code to represent these type parameters. When the user of this class declares a variable of type Result, they will specify the actual types to substitute for E and V. The variable declaration might look like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token literal-property property">result</span><span class="token operator">:</span> Result<span class="token operator">&lt;</span>TypeError<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
And here is how the parameterized <span class="token keyword">class</span> <span class="token class-name">is</span> <span class="token literal-property property">defined</span><span class="token operator">:</span>

<span class="token comment">// @flow</span>
<span class="token comment">// This class represents the result of an operation that can either</span>
<span class="token comment">// throw an error of type E or a value of type V.</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token constant">E</span><span class="token punctuation">;</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token constant">V</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token constant">V</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">threw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token constant">E</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token function">returned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token constant">V</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token constant">V</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Error and value must not both be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>And you can even define type parameters for functions:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token comment">// Combine the elements of two arrays into an array of pairs</span>
<span class="token keyword">function</span> zip<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token operator">:</span>Array<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span>Array<span class="token operator">&lt;</span><span class="token constant">B</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token constant">B</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token literal-property property">result</span><span class="token operator">:</span>Array<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token operator">?</span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token constant">B</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length<span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create the array [[1,'a'], [2,'b'], [3,'c'], [4,undefined]]</span>
<span class="token keyword">let</span> <span class="token literal-property property">pairs</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token operator">?</span>number<span class="token punctuation">,</span><span class="token operator">?</span>string<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_17-8-8-read-only-types"><a href="#_17-8-8-read-only-types" class="header-anchor">#</a> 17.8.8 Read-Only Types</h3> <p>Flow defines some special parameterized “utility types” that have names beginning with $. Most of these types have advanced use cases that we are not going to cover here. But two of them are quite useful in practice. If you have an object type T and want to make a read-only version of that type, just write <code>$ReadOnly&lt;T&gt;</code>. Similarly, you can write <code>$ReadOnlyArray&lt;T&gt;</code> to describe a read-only array with elements of type T.</p> <p>The reason to use these types is not because they can offer any guarantee that an object or array can’t be modified (see Object.freeze() in §14.2 if you want true read-only objects) but because it allows you to catch bugs caused by unintentional modifications. If you write a function that takes an object or array argument and does not change any of the object’s properties or the array’s elements, then you can annotate the function parameter with one of Flow’s read-only types. If you do this, then Flow will report an error if you forget and accidentally modify the input value. Here are two examples:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
type Point <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span>number<span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span>number<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// This function takes a Point object but promises not to modify it</span>
<span class="token keyword">function</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">p</span><span class="token operator">:</span> $ReadOnly<span class="token operator">&lt;</span>Point<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">hypot</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token literal-property property">p</span><span class="token operator">:</span> Point <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">distance</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment">// =&gt; 5</span>

<span class="token comment">// This function takes an array of numbers that it will not modify</span>
<span class="token keyword">function</span> <span class="token function">average</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">data</span><span class="token operator">:</span> $ReadOnlyArray<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> sum <span class="token operator">+=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sum<span class="token operator">/</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token literal-property property">data</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">average</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// =&gt; 3</span>
</code></pre></div><h3 id="_17-8-9-function-types"><a href="#_17-8-9-function-types" class="header-anchor">#</a> 17.8.9 Function Types</h3> <p>We have seen how to add type annotations to specify the types of a function’s parameters and its return type. But when one of the parameters of a function is itself a function, we need to be able to specify the type of that function parameter.</p> <p>To express the type of a function with Flow, write the types of each parameter, separate them with commas, enclose them in parentheses, and then follow that with an arrow and type return type of the function.</p> <p>Here is an example function that expects to be passed a callback function. Notice how we defined a type alias for the type of the callback function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token comment">// The type of the callback function used in fetchText() below</span>
<span class="token keyword">export</span> type <span class="token function-variable function">FetchTextCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">?</span>Error<span class="token punctuation">,</span> <span class="token operator">?</span>number<span class="token punctuation">,</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">fetchText</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">url</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">callback</span><span class="token operator">:</span> FetchTextCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            status <span class="token operator">=</span> response<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_17-8-10-union-types"><a href="#_17-8-10-union-types" class="header-anchor">#</a> 17.8.10 Union Types</h3> <p>Let’s return one more time to the size() function. It doesn’t really make sense to have a function that does nothing other than return the length of an array. Arrays have a perfectly good length property for that. But size() might be useful if it could take any kind of collection object (an array or a Set or a Map) and return the number of elements in the collection. In regular untyped JavaScript it would be easy to write a size() function like that. With Flow, we need a way to express a type that allows arrays, Sets, and Maps, but doesn’t allow values of any other type.</p> <p>Flow calls types like this Union types and allows you to express them by simply listing the desired types and separating them with vertical bar characters:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">collection</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span><span class="token operator">|</span>Set<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span><span class="token operator">|</span>Map<span class="token operator">&lt;</span>mixed<span class="token punctuation">,</span>mixed<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> collection<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> collection<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">&quot;three&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; 5</span>
</code></pre></div><p>Union types can be read using the word “or”—“an array or a Set or a Map”—so the fact that this Flow syntax uses the same vertical bar character as JavaScript’s OR operators is intentional.</p> <p>We saw earlier that putting a question mark before a type allows null and undefined values. And now you can see that a ? prefix is simply a shortcut for adding a |null|void suffix to a type.</p> <p>In general, when you annotate a value with a Union type, Flow will not allow you to use that value until you’ve done enough tests to figure out what the type of the actual value is. In the size() example we just looked at, we need to explicitly check whether the argument is an array before we try to access the length property of the argument. Note that we do not have to distinguish a Set argument from a Map argument, however: both of those classes define a size property, so the code in the else clause is safe as long as the argument is not an array.</p> <h3 id="_17-8-11-enumerated-types-and-discriminated-unions"><a href="#_17-8-11-enumerated-types-and-discriminated-unions" class="header-anchor">#</a> 17.8.11 Enumerated Types and Discriminated Unions</h3> <p>Flow allows you to use primitive literals as types that consist of that one single value. If you write let x:3;, then Flow will not allow you to assign any value to that variable other than 3. It is not often useful to define types that have only a single member, but a union of literal types can be useful. You can probably imagine a use for types like these, for example:</p> <div class="language-js extra-class"><pre class="language-js"><code>type Answer <span class="token operator">=</span> <span class="token string">&quot;yes&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;no&quot;</span><span class="token punctuation">;</span>
type Digit <span class="token operator">=</span> <span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">3</span><span class="token operator">|</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">5</span><span class="token operator">|</span><span class="token number">6</span><span class="token operator">|</span><span class="token number">7</span><span class="token operator">|</span><span class="token number">8</span><span class="token operator">|</span><span class="token number">9</span><span class="token punctuation">;</span>
If you use types made up <span class="token keyword">of</span> literals<span class="token punctuation">,</span> you need to understand that only literal values are allowed<span class="token operator">:</span>

<span class="token keyword">let</span> <span class="token literal-property property">a</span><span class="token operator">:</span> Answer <span class="token operator">=</span> <span class="token string">&quot;Yes&quot;</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Error: can't assign string to Answer</span>
<span class="token keyword">let</span> <span class="token literal-property property">d</span><span class="token operator">:</span> Digit <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">;</span>                  <span class="token comment">// Error: can't assign number to Digit</span>
</code></pre></div><p>When Flow checks your types, it does not actually do the calculations: it just checks the types of the calculations. Flow knows that toLowerCase() returns a string and that the + operator on numbers returns a number. Even though we know that both of these calculations return values that are within the type, Flow cannot know that and flags errors on both of these lines.</p> <p>A union type of literal types like Answer and Digit is an example of an enumerated type, or enum. A canonical use case for enum types is to represent the suits of playing cards:</p> <div class="language-js extra-class"><pre class="language-js"><code>type Suit <span class="token operator">=</span> <span class="token string">&quot;Clubs&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;Diamonds&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;Hearts&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;Spades&quot;</span><span class="token punctuation">;</span>
<span class="token constant">A</span> more relevant example might be <span class="token constant">HTTP</span> status codes<span class="token operator">:</span>

type HTTPStatus <span class="token operator">=</span>
    <span class="token operator">|</span> <span class="token number">200</span>    <span class="token comment">// OK</span>
    <span class="token operator">|</span> <span class="token number">304</span>    <span class="token comment">// Not Modified</span>
    <span class="token operator">|</span> <span class="token number">403</span>    <span class="token comment">// Forbidden</span>
    <span class="token operator">|</span> <span class="token number">404</span><span class="token punctuation">;</span>   <span class="token comment">// Not Found</span>
</code></pre></div><p>One of the pieces of advice that new programmers often hear is to avoid using literals in their code and to instead define symbolic constants to represent those values. One practical reason for this is to avoid the problem of typos: if you misspell a string literal like “Diamonds” JavaScript may never complain but your code may not work right. If you mistype an identifier, on the other hand, JavaScript is likely to throw an error that you’ll notice. With Flow, this advice does not always apply. If you annotate a variable with the type Suit, and then try to assign a misspelled suit to it, Flow will alert you to the error.</p> <p>Another important use for literal types is the creation of discriminated unions. When you work with union types (made up of actually different types, not of literals), you typically have to write code to discriminate among the possible types. In the previous section, we wrote a function that could take an array or a Set or a Map as its argument and had to write code to discriminate array input from Set or Map input. If you want to create a union of Object types, you can make these types easy to discriminate by using a literal type within each of the individual Object types.</p> <p>An example will make this clear. Suppose you’re using a worker thread in Node (§16.11) and are using postMessage() and “message” events for sending object-based messages between the main thread and the worker thread. There are multiple types of messages that the worker might want to send to the main thread, but we’d like to write a Flow Union type that describes all possible messages. Consider this code:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @flow</span>
<span class="token comment">// The worker sends a message of this type when it is done</span>
<span class="token comment">// reticulating the splines we sent it.</span>
<span class="token keyword">export</span> type ResultMessage <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">messageType</span><span class="token operator">:</span> <span class="token string">&quot;result&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">result</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>ReticulatedSpline<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// Assume this type is defined elsewhere.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The worker sends a message of this type if its code failed with an exception.</span>
<span class="token keyword">export</span> type ErrorMessage <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">messageType</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">error</span><span class="token operator">:</span> Error<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The worker sends a message of this type to report usage statistics.</span>
<span class="token keyword">export</span> type StatisticsMessage <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">messageType</span><span class="token operator">:</span> <span class="token string">&quot;stats&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">splinesReticulated</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
    <span class="token literal-property property">splinesPerSecond</span><span class="token operator">:</span> number
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// When we receive a message from the worker it will be a WorkerMessage.</span>
<span class="token keyword">export</span> type WorkerMessage <span class="token operator">=</span> ResultMessage <span class="token operator">|</span> ErrorMessage <span class="token operator">|</span> StatisticsMessage<span class="token punctuation">;</span>

<span class="token comment">// The main thread will have an event handler function that is passed</span>
<span class="token comment">// a WorkerMessage. But because we've carefully defined each of the</span>
<span class="token comment">// message types to have a messageType property with a literal type,</span>
<span class="token comment">// the event handler can easily discriminate among the possible messages:</span>
<span class="token keyword">function</span> <span class="token function">handleMessageFromReticulator</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">message</span><span class="token operator">:</span> WorkerMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>messageType <span class="token operator">===</span> <span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only ResultMessage has a messageType property with this value</span>
        <span class="token comment">// so Flow knows that it is safe to use message.result here.</span>
        <span class="token comment">// And Flow will complain if you try to use any other property.</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>messageType <span class="token operator">===</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only ErrorMessage has a messageType property with value &quot;error&quot;</span>
        <span class="token comment">// so knows that it is safe to use message.error here.</span>
        <span class="token keyword">throw</span> message<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>messageType <span class="token operator">===</span> <span class="token string">&quot;stats&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only StatisticsMessage has a messageType property with value &quot;stats&quot;</span>
        <span class="token comment">// so knows that it is safe to use message.splinesPerSecond here.</span>
        console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>splinesPerSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_17-9-summary"><a href="#_17-9-summary" class="header-anchor">#</a> 17.9 Summary</h2> <p>JavaScript is the most-used programming language in the world today. It is a living language—one that continues to evolve and improve—surrounded by a flourishing ecosystem of libraries, tools, and extensions. This chapter introduced some of those tools and extensions, but there are many more to learn about. The JavaScript ecosystem flourishes because the JavaScript developer community is active and vibrant, full of peers who share their knowledge through blog posts, videos, and conference presentations. As you close this book and go forth to join this community, you will find no shortage of information sources to keep you engaged with and learning about JavaScript.</p> <p>Best wishes, David Flanagan, March 2020</p> <hr> <ol><li>If you have programmed with Java, you may have experienced something like this the first time you wrote a generic API that used a type parameter. I found the learning process for Flow to be remarkably similar to what I went through in 2004 when generics were added to Java.</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/rexhang/rexhang.github.io/ebook/doc-jstdg7/edit/master/ch17.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新于:</span> <span class="time">2/22/2025, 9:58:16 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./ch16.html" class="prev">
        Chapter 16. Server-Side JavaScript with Node
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.806b1433.js" defer></script><script src="./assets/js/2.d222cfdb.js" defer></script><script src="./assets/js/1.7462a745.js" defer></script><script src="./assets/js/32.239f4c63.js" defer></script>
  </body>
</html>
